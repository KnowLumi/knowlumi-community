<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lumi Community</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="tailwind.min.css">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            min-height: 100vh;
            color: white;
            font-family: 'Poppins', sans-serif;
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            margin-top: 80px; /* Add margin to account for fixed header */
        }
        .welcome-card {
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .stat-card {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card.loading {
            min-height: 140px;
        }
        .stat-card.loading .loading-overlay {
            opacity: 1;
            visibility: visible;
        }
        .loading-overlay {
            background: rgba(17, 24, 39, 0.8);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            border-radius: 0.75rem;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4ade80;
            margin: 0.5rem 0;
        }
        .btn-logout {
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .btn-logout {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .btn-logout i {
                margin-right: 0.25rem;
            }
        }
        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <header class="bg-black shadow-md fixed w-full top-0 z-50">
        <div class="w-full max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="text-xl sm:text-2xl font-bold text-green-400 truncate max-w-[60%]">Lumi Community</a>
            <button id="logoutBtn" class="btn-logout ml-2">
                <i class="fas fa-sign-out-alt mr-1 sm:mr-2"></i>
                <span class="hidden sm:inline">Logout</span>
                <span class="sm:hidden">Logout</span>
            </button>
        </div>
    </header>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <div class="welcome-card">
            <div class="flex justify-between items-start">
                <div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Welcome back, <span id="userName" class="text-green-400"></span>!</h1>
                        <p class="text-gray-400 text-sm mt-1">Lumi ID: <span id="userLumiId" class="font-mono"></span></p>
                    </div>
                    <p class="text-gray-300">Here's what's happening with your account today.</p>
                </div>
                <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center text-2xl font-bold">
                    <span id="userInitial">U</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card relative">
                    <div class="absolute inset-0 flex items-center justify-center loading-overlay">
                        <div class="animate-pulse flex space-x-2">
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    <h3 class="text-gray-400 text-sm font-medium">Your Rank</h3>
                    <div id="userRank" class="stat-value">#-</div>
                    <p class="text-sm text-gray-400">Global ranking</p>
                </div>
                <div class="stat-card relative">
                    <div class="absolute inset-0 flex items-center justify-center loading-overlay">
                        <div class="animate-pulse flex space-x-2">
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    <h3 class="text-gray-400 text-sm font-medium">Total Points</h3>
                    <div id="totalPoints" class="stat-value">0</div>
                    <p class="text-sm text-gray-400">Your total score</p>
                </div>
                <div class="stat-card relative">
                    <div class="absolute inset-0 flex items-center justify-center loading-overlay">
                        <div class="animate-pulse flex space-x-2">
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="h-2 w-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    <h3 class="text-gray-400 text-sm font-medium">Lumi Coin</h3>
                    <div id="remainingCoins" class="stat-value">0</div>
                    <p class="text-sm text-gray-400">Available to spend</p>
                </div>
            </div>
        </div>

        <!-- Add more dashboard sections here -->
        <div class="welcome-card">
            <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <a href="leaderboard.html" class="bg-gray-800 hover:bg-gray-700 p-4 rounded-lg transition-colors flex items-center">
                    <div class="bg-green-500/20 p-3 rounded-lg mr-4">
                        <i class="fas fa-trophy text-green-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium">Leaderboard</h3>
                        <p class="text-sm text-gray-400">View rankings</p>
                    </div>
                </a>
                <a href="https://cart.knowlumi.com/" target="_blank" rel="noopener noreferrer" class="bg-gray-800 hover:bg-gray-700 p-4 rounded-lg transition-colors flex items-center">
                    <div class="bg-blue-500/20 p-3 rounded-lg mr-4">
                        <i class="fas fa-shopping-cart text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium">Lumi Cart</h3>
                        <p class="text-sm text-gray-400">View details</p>
                    </div>
                </a>
                <a href="tasks.html" class="bg-gray-800 hover:bg-gray-700 p-4 rounded-lg transition-colors flex items-center">
                    <div class="bg-purple-500/20 p-3 rounded-lg mr-4">
                        <i class="fas fa-tasks text-purple-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium">Tasks</h3>
                        <p class="text-sm text-gray-400">View & complete tasks</p>
                    </div>
                </a>
                <a href="#" class="bg-gray-800 hover:bg-gray-700 p-4 rounded-lg transition-colors flex items-center">
                    <div class="bg-indigo-500/20 p-3 rounded-lg mr-4">
                        <i class="fas fa-laptop-code text-indigo-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium">Programs</h3>
                        <p class="text-sm text-gray-400">View programs</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Cache duration in milliseconds (1 minute)
        const CACHE_DURATION = 1 * 60 * 1000;
        
        // Helper function to get cached data
        function getCachedData(key) {
            const cached = localStorage.getItem(key);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            const now = new Date().getTime();
            
            if (now - timestamp < CACHE_DURATION) {
                return data;
            }
            return null;
        }
        
        // Helper function to cache data
        function cacheData(key, data) {
            const cache = {
                data,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(key, JSON.stringify(cache));
            return data;
        }
        
        // Function to fetch leaderboard data and find user's rank
        async function getUserRank(lumiId, forceRefresh = false) {
            const cacheKey = `leaderboard_rank_${lumiId}`;
            
            // Try to load from cache if not forcing refresh
            if (!forceRefresh) {
                const cachedRank = getCachedData(cacheKey);
                if (cachedRank !== null) {
                    // Refresh in background
                    setTimeout(() => getUserRank(lumiId, true), 0);
                    return cachedRank;
                }
            }
            try {
                // Use the same endpoint as leaderboard.html
                const response = await fetch(`https://script.google.com/macros/s/AKfycbwbSZv6LCM83f9NUGu-qKZBn4BiVqCCueuv3eE5YUU5avt6zOtv_xrlSR_Qp5UyRUDy/exec?action=getLeaderboardData&t=${Date.now()}`);
                if (!response.ok) {
                    console.error('Failed to fetch leaderboard data:', response.status);
                    return null;
                }
                
                const leaderboardData = await response.json();
                console.log('Leaderboard data:', leaderboardData);
                
                if (!Array.isArray(leaderboardData)) {
                    console.error('Unexpected leaderboard data format:', leaderboardData);
                    return null;
                }
                
                // Filter out entries with no points and sort by totalPoints in descending order
                const sortedData = leaderboardData
                    .filter(user => user && user.id && (user.totalPoints || user.totalPoints === 0))
                    .sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
                
                console.log('Sorted leaderboard data:', sortedData);
                
                // Find the user's rank (1-based index)
                const userIndex = sortedData.findIndex(user => 
                    user.id && user.id.toString().trim().toLowerCase() === lumiId.trim().toLowerCase()
                );
                
                console.log('User index found:', userIndex, 'for Lumi ID:', lumiId);
                
                // Return the rank (add 1 because array is 0-based)
                const rank = userIndex !== -1 ? userIndex + 1 : null;
                
                // Cache the result
                if (forceRefresh || !getCachedData(cacheKey)) {
                    cacheData(cacheKey, rank);
                }
                
                return rank;
            } catch (error) {
                console.error('Error in getUserRank:', error);
                return null;
            }
        }


        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', async function() {
            const lumiId = localStorage.getItem('lumiId') || sessionStorage.getItem('lumiId');
            const isLoggedIn = localStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn');
            
            if (!isLoggedIn || !lumiId) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }
            
            // Display user info
            document.getElementById('userLumiId').textContent = lumiId;
            document.getElementById('userInitial').textContent = lumiId.charAt(0).toUpperCase();
            // Set the user name (will be updated if available from user data)
            document.getElementById('userName').textContent = lumiId;
            
            // Show loading state for stats
            function showLoadingStats() {
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.add('loading');
                });
            }
            
            // Hide loading state for stats
            function hideLoadingStats() {
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.remove('loading');
                });
            }

            // Function to fetch user data
            async function fetchUserData(userId, forceRefresh = false) {
                // Loading state is now managed by the caller
                try {
                    const response = await fetch(`https://script.google.com/macros/s/AKfycbxL-8OP4-zkJ187IMhnrvBk7_vrF0hfkX3K8YkmMcqefN0hjt8L-wgJUktRjerO4LBD/exec?lumiID=${encodeURIComponent(userId)}${forceRefresh ? '&t=' + Date.now() : ''}`);
                    if (!response.ok) throw new Error('Failed to fetch user data');
                    
                    const data = await response.json();
                    if (data) {
                        // Cache the data
                        cacheData(`user_data_${userId}`, data);
                        // Hide loading state when data is loaded
                        setTimeout(hideLoadingStats, 500); // Small delay for better UX
                    }
                    return data;
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Hide loading state on error
                    hideLoadingStats();
                    return null;
                }
            }
            
            // Fetch user data with caching
            try {
                const userCacheKey = `user_data_${lumiId}`;
                let userData = null;
                
                // Try to load from cache first
                const cachedData = getCachedData(userCacheKey);
                if (cachedData) {
                    userData = cachedData;
                    // Don't show loading animation since we have cached data
                    hideLoadingStats();
                    // Update in background
                    setTimeout(() => fetchUserData(lumiId, true), 0);
                } else {
                    // Only show loading if we don't have cached data
                    showLoadingStats();
                    userData = await fetchUserData(lumiId);
                }
                

                
                // Update the UI with user data
                if (userData) {
                    // Update points and coins
                    document.getElementById('totalPoints').textContent = userData.totalPoints || '0';
                    document.getElementById('remainingCoins').textContent = userData.remainingCoins || '0';
                    
                    // If studentName is available, use it for the name display
                    if (userData.studentName) {
                        document.getElementById('userName').textContent = userData.studentName;
                        document.getElementById('userInitial').textContent = userData.studentName.charAt(0).toUpperCase();
                    } else {
                        // Fallback to Lumi ID if no name is available
                        document.getElementById('userName').textContent = lumiId;
                    }
                    
                    // Update rank display
                    const rankElement = document.getElementById('userRank');
                    const totalPoints = parseInt(document.getElementById('totalPoints').textContent) || 0;
                    const rankInfo = document.querySelector('#userRank').parentElement.querySelector('p');
                    
                    // Always try to get the rank, even if points are 0
                    const userRank = await getUserRank(lumiId);
                    console.log('User rank fetched:', userRank);
                    
                    if (userRank !== null) {
                        rankElement.textContent = `#${userRank}`;
                        rankElement.classList.remove('text-sm', 'text-gray-400');
                        rankInfo.textContent = 'Global ranking';
                    } else if (totalPoints === 0) {
                        rankElement.textContent = 'Earn points to get ranked';
                        rankElement.classList.add('text-sm', 'text-gray-400');
                        rankInfo.textContent = 'Start participating in activities';
                    } else {
                        rankElement.textContent = 'Rank not available';
                        rankElement.classList.add('text-sm', 'text-gray-400');
                        rankInfo.textContent = 'Global ranking';
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                // Fallback to default values if API fails
                document.getElementById('totalPoints').textContent = '0';
                document.getElementById('remainingCoins').textContent = '0';
            }
            
            // Setup logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                // Clear all auth data
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('lumiId');
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('lumiId');
                
                // Redirect to login page
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>
